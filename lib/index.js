var e,r=require("did-jwt-vc"),t=require("infra-did-resolver"),n=(e=require("infra-did-js"))&&"object"==typeof e&&"default"in e?e.default:e;function i(){return(i=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function o(e,r){return r()}const s=new RegExp("^did:([a-zA-Z0-9_]+):([a-zA-Z0-9_.%-]+(:[a-zA-Z0-9_.%-]+)*)((;[a-zA-Z0-9_.:%-]+=[a-zA-Z0-9_.:%-]*)*)(/[^#?]*)?([?][^#]*)?(#.*)?$");function a(e){if(""===e||!e)return null;const r=e.match(s);if(r){const t={did:`did:${r[1]}:${r[2]}`,method:r[1],id:r[2],didUrl:e};if(r[4]){const e=r[4].slice(1).split(";");t.params={};for(const r of e){const e=r.split("=");t.params[e[0]]=e[1]}}return r[6]&&(t.path=r[6]),r[7]&&(t.query=r[7].slice(1)),r[8]&&(t.fragment=r[8].slice(1)),t}return null}const d={didResolutionMetadata:{},didDocument:null,didDocumentMetadata:{}};function u(e){return async(r,t,n)=>{try{const o=await e(r,t,n);return i({},d,{didResolutionMetadata:{contentType:"application/did+ld+json"},didDocument:o})}catch(e){return i({},d,{didResolutionMetadata:{error:"notFound",message:e.toString()}})}}}class c{constructor(e={},r={}){this.registry=e,this.cache=!0===r.cache?function(){const e=new Map;return async(r,t)=>{var n;if(r.params&&"true"===r.params["no-cache"])return await t();const i=e.get(r.didUrl);if(void 0!==i)return i;const o=await t();return"notFound"!==(null==(n=o.didResolutionMetadata)?void 0:n.error)&&e.set(r.didUrl,o),o}}():r.cache||o,r.legacyResolvers&&Object.keys(r.legacyResolvers).map(e=>{this.registry[e]||(this.registry[e]=u(r.legacyResolvers[e]))})}async resolve(e,r={}){const t=a(e);if(null===t)return i({},d,{didResolutionMetadata:{error:"invalidDid"}});const n=this.registry[t.method];return n?this.cache(t,()=>n(t.did,t,this,r)):i({},d,{didResolutionMetadata:{error:"unsupportedDidMethod"}})}}module.exports=function(){function e(e){this.resolver=e.resolver?e.resolver:new c(t.getResolver(e.networkConfig)),this.did=e.did?e.did:n.createPubKeyDIDsecp256k1("01").did,this.knownIssuer=e.knownIssuer}var i=e.prototype;return i.ready=function(){return this.challenge=this.generateChallenge(),{challenge:this.challenge,aud:this.did}},i.generateChallenge=function(){return n.createPubKeyDIDsecp256k1("01").did},i.isValidVP=function(e){try{var t=this;return Promise.resolve(r.verifyPresentation(e,t.resolver,{challenge:t.challenge,audience:t.did})).then(function(e){var r=e.payload.vp.VerifiedCredential,n=e.payload.signer;if(t.isRevoked(n.did))throw new Error("Deactivated Presenter");return r.map(function(e){return t.isValidVC(e,n.did)},t).reduce(function(e,r){return e&&r},!0)})}catch(e){return Promise.reject(e)}},i.isValidVC=function(e,t){try{var n=this;return Promise.resolve(r.verifyCredential(e,n.resolver)).then(function(e){if(t&&e.payload.sub!==t)throw new Error("Signer is not the subject of VC");if(n.isKnownIssuer(e.issuer))throw new Error("Unknown Issuer");if(n.isRevoked(e.issuer))throw new Error("Deactivated Issuer");if(n.isRevoked(e.payload.vc.id))throw new Error("Revoked VC");return!0})}catch(e){return Promise.reject(e)}},i.isRevoked=function(e){try{return Promise.resolve(this.resolver.resolve(e)).then(function(e){return!!e.didDocumentMetadata.deactivated})}catch(e){return Promise.reject(e)}},i.isKnownIssuer=function(e){for(var r in this.knownIssuer)if(this.knownIssuer[r]===e)return!0;return!1},e}();
//# sourceMappingURL=index.js.map
